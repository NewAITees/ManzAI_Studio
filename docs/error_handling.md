# エラーハンドリングガイド

## エラーレスポンスの形式

すべてのエラーレスポンスは以下の形式で返されます：

```json
{
    "error": "エラーメッセージ",
    "code": "エラーコード",
    "details": {}  // オプショナル
}
```

## HTTPステータスコード

| ステータスコード | 説明 | 対応方法 |
|--------------|------|---------|
| 400 | Bad Request | リクエストの形式や内容を確認してください |
| 401 | Unauthorized | 認証情報を確認してください |
| 403 | Forbidden | アクセス権限を確認してください |
| 404 | Not Found | リソースの存在を確認してください |
| 415 | Unsupported Media Type | Content-Typeを確認してください |
| 429 | Too Many Requests | リクエストの頻度を下げてください |
| 500 | Internal Server Error | サーバー側の問題です。管理者に連絡してください |

## エラーコード一覧

### 共通エラー (APP_*)

| コード | 説明 | 対応方法 |
|-------|------|---------|
| APP_ERROR | 一般的なアプリケーションエラー | エラーメッセージを確認し、適切な対応を行ってください |
| VALIDATION_ERROR | 入力値の検証エラー | リクエストの内容を確認し、必要な修正を行ってください |

### API関連エラー (API_*)

| コード | 説明 | 対応方法 |
|-------|------|---------|
| API_ERROR_400 | 不正なリクエスト | リクエストの形式や内容を確認してください |
| API_ERROR_415 | 不適切なContent-Type | 正しいContent-Typeを設定してください |
| API_ERROR_500 | サーバー内部エラー | サーバー管理者に連絡してください |

### モデルサービスエラー (MODEL_*)

| コード | 説明 | 対応方法 |
|-------|------|---------|
| MODEL_SERVICE_ERROR | モデル操作に関するエラー | モデルの状態や設定を確認してください |
| MODEL_NOT_FOUND | 指定されたモデルが見つからない | モデル名や存在を確認してください |
| MODEL_INVALID | モデルが無効または破損している | モデルファイルを確認してください |

## エラーハンドリングのベストプラクティス

1. **適切なエラーコードの使用**
   - エラーの性質に合わせて適切なHTTPステータスコードを使用
   - 具体的なエラーコードで詳細情報を提供

2. **エラーメッセージの明確化**
   - ユーザーが理解しやすい明確なメッセージを提供
   - 技術的な詳細は`details`フィールドに格納

3. **ログ記録**
   - エラーの発生をログに記録
   - デバッグに必要な情報を含める

4. **セキュリティ考慮**
   - センシティブな情報をエラーメッセージに含めない
   - スタックトレースは本番環境で公開しない

## エラーハンドリングの実装例

```python
try:
    # 処理
    result = process_request()
except ValidationError as e:
    logger.warning(f"バリデーションエラー: {e}")
    return jsonify({
        "error": str(e),
        "code": "VALIDATION_ERROR"
    }), 400
except ContentTypeError as e:
    logger.warning(f"Content-Typeエラー: {e}")
    return jsonify({
        "error": str(e),
        "code": "API_ERROR_415"
    }), 415
except Exception as e:
    logger.error(f"予期せぬエラー: {e}")
    return jsonify({
        "error": "Internal Server Error",
        "code": "APP_ERROR"
    }), 500
```

## エラーの予防と対策

1. **入力値の検証**
   - リクエストデータの型と形式を検証
   - 必須フィールドの存在確認
   - 値の範囲チェック

2. **Content-Type検証**
   - リクエストヘッダーの検証
   - エンドポイントに応じた適切な形式の確認

3. **エラー監視**
   - エラーの発生頻度を監視
   - パターンの分析と対策
   - 定期的なログ分析

4. **テスト**
   - エラーケースのユニットテスト
   - エッジケースの考慮
   - 統合テストでのエラー確認
